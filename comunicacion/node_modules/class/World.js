exports.World = function( params ){

	var defaults = {

		"tiles" : null,

		"createdObjects": {},

		"stats":{
			"levelGrowth": { // Ganancia al pasar de nivel
				"experience" : 1.4, // Multiplicador de la exp necesaria x nivel.
				"life": 10,
				"damage": 1
			}
		}

	}

	merge( defaults , params , this );

	this.create = function(){
		this.tiles = createArray( 30 , 30 , Tile );
		this.loadTiles([[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua}],[{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Tierra},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua},{terrain:Agua}]] );
	}

	// Sirve para lo usuarios que se loguean
	this.createBeing = function( params ){
		var temporalObject;
		temporalObject = new Elfo({
			"position":{
				"x": 1,
				"y": 1
			},
			"name":"miElfo",
			"controls":"pc",
			"id":params.userId
		})

		this.createdObjects[temporalObject.id] = temporalObject;
		this.refreshTiles({ "element" : temporalObject });
	}

	// Encuentra Being por id, sirve para cuando se envian controls, hacer que afecten al being con el ID dado por el cliente.
	this.findBeing = function( params ){
		//console.log( world.createdObjects[ params.id ] )
		return this.createdObjects[ params.userId ];
	}

	// Borra objeto del mapa
	this.removeObject = function( params ){
		this.createdObjects[ params.object.id ] = null;
	}

	// Carga los tiles desde un array en donde se le define el terrain de cada uno.
	this.loadTiles = function( params ){
		for( var tx = 0 ; tx < params.length ; tx++ ){
			for( var ty = 0 ; ty < params[tx].length ; ty++ ){
				this.tiles[tx][ty].terrain = new params[ty][tx].terrain({"position":{"x":tx,"y":ty}});
			}
		}
	}

	// Devuelve tile en base a una posicion dada.
	this.getTile = function( position ){
		if( this.tiles[ position.x ] && this.tiles[ position.x ][ position.y ] ){
			return this.tiles[ position.x ][ position.y ];
		}else{
			return false;
		}

	}

	// refresca posicion de un elemento ( being , terrain u object)
	this.refreshTiles = function( params ){

		// Verifica en que capa esta el objeto
		var element_type;
		switch( params.element.type ){
			case "being":
				element_type = 'being';
				break;
			default:
				break;
		}
		// borra de la posicion anterior.
		if( params.lastPosition !== undefined ){
			this.getTile( params.lastPosition )[element_type] = null;
		}

		// lo crea en la nueva posicion.
		this.getTile( params.element.position )[element_type] = params.element;

		// Actualizo tiles en el cliente.
		var being = this.getTile( params.element.position )[element_type]
		if( params.lastPosition !== undefined ){
			being.updateRemoveTile({ "object" : being , "lastPosition" : params.lastPosition }); // Si esta definida lastPosition, borra la ultima posicion
		}else{
			being.updateRemoveTile({ "object" : being , "lastPosition" : being.position }); // Si esta definida lastPosition, borra la ultima posicion
		}

	}

}
